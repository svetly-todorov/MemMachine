name: Run REST Client Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

# Cancel any preceding run on the pull request after a new commit is pushed.
concurrency:
  group: rest-client-integration-test-${{ github.event.pull_request.number || github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ (github.event.pull_request.head.ref || github.ref) != 'refs/heads/main' }}

jobs:
  rest-client-integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Set job timeout to 30 minutes
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install the latest version of uv and set the python version
        uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create .env file for Docker Compose
        run: |
          cat > .env << EOF
          POSTGRES_HOST=postgres
          POSTGRES_PORT=5432
          POSTGRES_USER=memmachine
          POSTGRES_PASSWORD=memmachine_password
          POSTGRES_DB=memmachine
          NEO4J_HOST=neo4j
          NEO4J_PORT=7687
          NEO4J_USER=neo4j
          NEO4J_PASSWORD=neo4j_password
          NEO4J_HTTP_PORT=7474
          NEO4J_HTTPS_PORT=7473
          MEMORY_CONFIG=/app/configuration.yml
          MCP_BASE_URL=http://memmachine:8080
          GATEWAY_URL=http://localhost:8080
          FAST_MCP_LOG_LEVEL=INFO
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          LOG_LEVEL=INFO
          MEMORY_SERVER_PORT=8080
          MEMMACHINE_IMAGE=memmachine/memmachine:latest-cpu
          EOF

      - name: Install PyYAML for configuration processing
        run: |
          pip install pyyaml

      - name: Prepare configuration.yml for CI
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Verify sample config exists
          if [ ! -f "sample_configs/episodic_memory_config.cpu.sample" ]; then
            echo "❌ Error: sample_configs/episodic_memory_config.cpu.sample not found"
            exit 1
          fi
          
          # Copy sample config if configuration.yml doesn't exist
          if [ ! -f "configuration.yml" ]; then
            echo "Copying sample config to configuration.yml..."
            cp sample_configs/episodic_memory_config.cpu.sample configuration.yml
          else
            echo "Using existing configuration.yml"
          fi
          
          # Verify configuration.yml was created
          if [ ! -f "configuration.yml" ]; then
            echo "❌ Error: Failed to create configuration.yml"
            exit 1
          fi
          
          # Use Python to safely update configuration.yml
          python3 << 'PYTHON_SCRIPT'
          import yaml
          import os
          import sys
          
          config_file = 'configuration.yml'
          with open(config_file, 'r') as f:
              config = yaml.safe_load(f)
          
          # Update database configurations
          if 'resources' in config and 'databases' in config['resources']:
              # Update PostgreSQL config
              if 'profile_storage' in config['resources']['databases']:
                  db_config = config['resources']['databases']['profile_storage']['config']
                  db_config['host'] = 'postgres'
                  db_config['user'] = 'memmachine'
                  db_config['password'] = 'memmachine_password'
                  db_config['db_name'] = 'memmachine'
              
              # Update Neo4j config
              if 'my_storage_id' in config['resources']['databases']:
                  neo4j_config = config['resources']['databases']['my_storage_id']['config']
                  neo4j_config['uri'] = 'bolt://neo4j:7687'
                  neo4j_config['username'] = 'neo4j'
                  neo4j_config['password'] = 'neo4j_password'
          
          # Update API key in embedders
          if 'resources' in config and 'embedders' in config['resources']:
              for embedder_name, embedder_config in config['resources']['embedders'].items():
                  if 'config' in embedder_config and 'api_key' in embedder_config['config']:
                      api_key = os.environ.get('OPENAI_API_KEY', '')
                      if api_key:
                          embedder_config['config']['api_key'] = api_key
          
          # Update API key in models
          if 'resources' in config and 'models' in config['resources']:
              for model_name, model_config in config['resources']['models'].items():
                  if 'config' in model_config and 'api_key' in model_config['config']:
                      api_key = os.environ.get('OPENAI_API_KEY', '')
                      if api_key:
                          model_config['config']['api_key'] = api_key
          
          with open(config_file, 'w') as f:
              yaml.dump(config, f, default_flow_style=False, sort_keys=False)
          PYTHON_SCRIPT

      - name: Build MemMachine Docker image
        run: |
          echo "Building MemMachine Docker image..."
          if [ ! -f "Dockerfile" ]; then
            echo "❌ Error: Dockerfile not found"
            exit 1
          fi
          docker build --build-arg GPU=false -t memmachine/memmachine:latest-cpu . || {
            echo "❌ Docker build failed"
            exit 1
          }
          echo "✅ Docker image built successfully"
          echo "Built images:"
          docker images | grep memmachine || echo "No memmachine images found"

      - name: Start MemMachine services with Docker Compose
        run: |
          echo "Starting Docker Compose services..."
          docker compose up -d
          echo "Services started. Waiting for them to be ready..."
          sleep 10  # Give services a moment to start
          docker compose ps

      - name: Wait for PostgreSQL to be ready
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          timeout 180 bash -c 'until docker exec memmachine-postgres pg_isready -U memmachine -d memmachine; do echo "$(date): Waiting for PostgreSQL..."; sleep 3; done'
          echo "PostgreSQL is ready"

      - name: Wait for Neo4j to be ready
        run: |
          echo "Waiting for Neo4j to be ready..."
          timeout 180 bash -c 'until docker exec memmachine-neo4j cypher-shell -u neo4j -p neo4j_password "RETURN 1" > /dev/null 2>&1; do echo "$(date): Waiting for Neo4j..."; sleep 3; done'
          echo "Neo4j is ready"

      - name: Wait for MemMachine API to be ready
        run: |
          echo "Waiting for MemMachine API to be ready..."
          timeout 300 bash -c 'until curl -f http://localhost:8080/api/v2/health > /dev/null 2>&1; do 
            echo "$(date): Waiting for MemMachine API..."
            echo "Checking container status..."
            docker ps | grep memmachine || echo "Container not running"
            echo "Last 20 lines of logs:"
            docker compose logs --tail=20 memmachine || true
            sleep 5
          done'
          echo "MemMachine API is ready"
          
      - name: Show service status
        run: |
          echo "=== Docker Compose Status ==="
          docker compose ps
          echo ""
          echo "=== MemMachine Container Status ==="
          docker ps -a | grep memmachine || echo "MemMachine container not found"
          echo ""
          echo "=== MemMachine Container Logs (last 100 lines) ==="
          docker compose logs --tail=100 memmachine || true
          echo ""
          echo "=== Checking if MemMachine container is running ==="
          if docker ps | grep -q memmachine-app; then
            echo "✅ MemMachine container is running"
          else
            echo "❌ MemMachine container is NOT running"
            echo "=== Full MemMachine logs ==="
            docker compose logs memmachine || true
            exit 1
          fi

      - name: Verify MemMachine health
        run: |
          curl -f http://localhost:8080/api/v2/health || exit 1
          echo "MemMachine health check passed"

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run REST client integration tests
        env:
          MEMORY_BACKEND_URL: http://localhost:8080
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          uv run pytest tests/memmachine/rest_client/test_integration_complete.py -v --integration -m integration

      - name: Show service logs on failure
        if: failure()
        run: |
          echo "=== MemMachine logs ==="
          docker compose logs memmachine || true
          echo "=== PostgreSQL logs ==="
          docker compose logs postgres || true
          echo "=== Neo4j logs ==="
          docker compose logs neo4j || true

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

